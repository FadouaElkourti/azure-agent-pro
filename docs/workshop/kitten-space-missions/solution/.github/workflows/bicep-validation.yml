name: Bicep Validation

on:
  pull_request:
    branches:
      - main
    paths:
      - 'docs/workshop/kitten-space-missions/solution/bicep/**'
      - '.github/workflows/bicep-validation.yml'

permissions:
  id-token: write  # Required for OIDC
  contents: read
  pull-requests: write  # Required to comment on PR

env:
  BICEP_PATH: docs/workshop/kitten-space-missions/solution/bicep
  RESOURCE_GROUP: rg-kitten-missions-dev
  LOCATION: westeurope

jobs:
  lint:
    name: Bicep Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bicep CLI
        run: |
          curl -Lo bicep https://github.com/Azure/bicep/releases/latest/download/bicep-linux-x64
          chmod +x ./bicep
          sudo mv ./bicep /usr/local/bin/bicep
          bicep --version

      - name: Lint Bicep files
        working-directory: ${{ env.BICEP_PATH }}
        run: |
          echo "üîç Linting Bicep files..."
          bicep build main.bicep
          
          echo ""
          echo "‚úÖ Bicep lint completed"

      - name: Lint individual modules
        working-directory: ${{ env.BICEP_PATH }}
        run: |
          echo "üîç Linting individual modules..."
          for file in modules/*.bicep; do
            echo "Linting: $file"
            bicep build "$file"
          done
          
          echo ""
          echo "‚úÖ All modules linted successfully"

  build:
    name: Bicep Build
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Validate Bicep template
        working-directory: ${{ env.BICEP_PATH }}
        run: |
          echo "‚úÖ Validating Bicep template against Azure..."
          az deployment group validate \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file main.bicep \
            --parameters parameters/dev.parameters.json

          echo ""
          echo "‚úÖ Template validation successful"

  security-scan:
    name: Security Scan (Checkov)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov security scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ${{ env.BICEP_PATH }}
          framework: bicep
          soft_fail: false
          output_format: cli,sarif
          output_file_path: console,results.sarif

      - name: Upload Checkov results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: checkov

  what-if:
    name: What-If Deployment
    runs-on: ubuntu-latest
    needs: [build, security-scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Run What-If deployment
        id: whatif
        working-directory: ${{ env.BICEP_PATH }}
        run: |
          echo "üîç Running What-If deployment analysis..."
          
          # Ejecutar what-if y capturar output
          WHATIF_OUTPUT=$(az deployment group what-if \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file main.bicep \
            --parameters parameters/dev.parameters.json \
            --result-format FullResourcePayloads 2>&1)
          
          echo "$WHATIF_OUTPUT"
          
          # Guardar para el comment
          echo "$WHATIF_OUTPUT" > /tmp/whatif-output.txt
          
          # Extraer resumen
          SUMMARY=$(echo "$WHATIF_OUTPUT" | grep "Resource changes:" || echo "No changes detected")
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
          
          echo ""
          echo "‚úÖ What-If analysis completed"

      - name: Comment PR with What-If results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const whatifOutput = fs.readFileSync('/tmp/whatif-output.txt', 'utf8');
            
            const body = `## üîç Bicep What-If Results
            
            **PR**: #${{ github.event.pull_request.number }}
            **Commit**: \`${{ github.sha }}\`
            **Resource Group**: \`${{ env.RESOURCE_GROUP }}\`
            
            ### Summary
            
            ${{ steps.whatif.outputs.summary }}
            
            <details>
            <summary>üìã Full What-If Output</summary>
            
            \`\`\`
            ${whatifOutput}
            \`\`\`
            
            </details>
            
            ---
            
            ‚úÖ **All validations passed**
            - Bicep lint: ‚úÖ Passed
            - Template validation: ‚úÖ Passed
            - Security scan (Checkov): ‚úÖ Passed
            - What-If analysis: ‚úÖ Completed
            
            **Note**: This is a preview. No resources will be deployed until PR is merged.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [lint, build, security-scan, what-if]
    if: always()
    steps:
      - name: Check validation results
        run: |
          echo "## üìä Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Bicep Lint | ${{ needs.lint.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bicep Build | ${{ needs.build.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| What-If | ${{ needs.what-if.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.lint.result }}" == "success" && \
                "${{ needs.build.result }}" == "success" && \
                "${{ needs.security-scan.result }}" == "success" && \
                "${{ needs.what-if.result }}" == "success" ]]; then
            echo "### ‚úÖ All validations passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This PR is ready to merge. Infrastructure changes have been validated." >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### ‚ùå Some validations failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed jobs and fix the issues before merging." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
